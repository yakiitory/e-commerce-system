{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/payments.css') }}">
<title>Your Payments</title>
{% endblock %}

<main class="content-wrapper">
{% block body %}
    <div class="payments-container">
        <h3>Your Payments</h3>

        <section class="virtual-card-section">
            <h4>Virtual Card</h4>
            {% if virtual_card %}
            <div class="card-and-actions">
                <div class="virtual-card">
                    <div class="card-balance">
                        <p>Current Balance</p>
                        <h2>₱{{ "{:,.2f}".format(virtual_card.balance) }}</h2>
                    </div>
                    <div class="card-details">
                        <p>Card Owner: <strong>{{ current_user.first_name }} {{ current_user.last_name }}</strong></p>
                        <p>Card ID: **** **** **** {{ (virtual_card.id | string)[-4:] }}</p>
                    </div>
                </div>
                <div class="card-actions">
                    <h5>Manage Card</h5>
                    <form action="{{ url_for('deposit_to_card') }}" method="post" class="deposit-form">
                        <label for="deposit-amount">Deposit Amount</label>
                        <div class="input-group">
                            <span>₱</span>
                            <input type="number" name="amount" id="deposit-amount" placeholder="e.g., 500" min="1" step="any" required>
                        </div>
                        <button type="submit" class="deposit-btn">Deposit Funds</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="activate-card-container">
                <p>Activate your FleaMart virtual card to start making secure payments.</p>
                <form action="{{ url_for('activate_card') }}" method="post">
                    <button type="submit" class="activate-btn">Activate Your Card Now</button>
                </form>
            </div>
            {% endif %}
        </section>

        <section class="payment-history-section">
            <h4>Payment History</h4>
            {% if payment_history %}
            <table class="payment-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>From/To</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payment_history %}
                    <tr>
                        <td>{{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        {% if payment.sender_id == current_user.id %}
                            {# User sent the payment #}
                            <td class="amount-sent">- ₱{{ "{:,.2f}".format(payment.amount) }}</td>
                            <td>To: {{ payment.receiver_type }}</td>
                        {% else %}
                            {# User received the payment #}
                            <td class="amount-received">+ ₱{{ "{:,.2f}".format(payment.amount) }}</td>
                            <td>From: {{ payment.sender_type }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>You have no payment history.</p>
            {% endif %}
        </section>
    </div>
{% endblock %}
</main>
